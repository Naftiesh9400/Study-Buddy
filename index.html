<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Buddy - AI Question Solver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }

        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 0.75rem;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { bottom: 30px; }

        .quiz-option.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Toast Notification -->
    <div id="toast" class="px-6 py-3 rounded-full text-white font-medium shadow-lg"></div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm space-y-5 text-center">
            <h2 id="confirmTitle" class="text-xl font-bold text-gray-900">Are you sure?</h2>
            <p id="confirmMessage" class="text-gray-600">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmOkBtn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>

    <div id="appContainer">

        <!-- Login Page -->
        <div id="loginPage" class="page min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Welcome Back!</h2>
                    <p class="text-gray-500 mt-2">Sign in to continue your journey.</p>
                </div>
                <div class="space-y-4">
                    <input id="loginEmail" type="email" placeholder="Email Address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="loginPassword" type="password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md">Login</button>
                    <p class="text-center text-sm text-gray-600 pt-2">
                        Don't have an account? <a href="#" id="showSignup" class="font-medium text-blue-600 hover:underline">Sign up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signupPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Create Account</h2>
                    <p class="text-gray-500 mt-2">Get started with your new study buddy.</p>
                </div>
                <div class="space-y-4">
                    <input id="signupName" type="text" placeholder="Full Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="signupEmail" type="email" placeholder="Email Address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="signupPassword" type="password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="signupBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md">Sign Up</button>
                    <p class="text-center text-sm text-gray-600 pt-2">
                        Already have an account? <a href="#" id="showLogin" class="font-medium text-blue-600 hover:underline">Login</a>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Setup Page -->
        <div id="setupPage" class="page hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-xl p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-900">Welcome, <span id="setupUserName"></span>!</h2>
                    <p class="text-gray-500 mt-2">Let's personalize your experience. What is your primary focus?</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
                    <div id="schoolCard" class="selection-card cursor-pointer bg-blue-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">School</h3>
                        <p class="text-sm mt-1">Class 10-12</p>
                    </div>
                    <div id="examCard" class="selection-card cursor-pointer bg-green-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">Competitive Exams</h3>
                        <p class="text-sm mt-1">JEE / NEET</p>
                    </div>
                    <div id="collegeCard" class="selection-card cursor-pointer bg-indigo-500 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h3 class="font-bold text-xl">College</h3>
                        <p class="text-sm mt-1">B.Tech, BCA etc.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main App Layout -->
        <div id="mainAppWrapper" class="page hidden flex flex-col min-h-screen">
            <header class="sticky top-0 z-40 w-full bg-white/80 backdrop-blur-lg border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center py-4">
                        <div class="flex items-center space-x-3">
                            <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18-3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0 0v14.25" />
                            </svg>
                            <h1 class="text-2xl font-bold text-gray-800">Study Buddy</h1>
                        </div>
                        <nav class="hidden md:flex items-center space-x-2">
                            <button data-page="mainAppPage" class="nav-btn text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Home</button>
                            <button data-page="quizListPage" class="nav-btn text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Quizzes</button>
                            <button data-page="announcementHistoryPage" class="nav-btn text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Announcements</button>
                            <button data-page="supportPage" class="nav-btn text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Support</button>
                            <button data-page="profilePage" class="nav-btn text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Profile</button>
                        </nav>
                        <div class="md:hidden">
                            <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-gray-100">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="mobileMenu" class="hidden md:hidden pb-4 space-y-1">
                        <button data-page="mainAppPage" class="nav-btn-mobile w-full text-left font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Home</button>
                        <button data-page="quizListPage" class="nav-btn-mobile w-full text-left font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Quizzes</button>
                        <button data-page="announcementHistoryPage" class="nav-btn-mobile w-full text-left font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Announcements</button>
                        <button data-page="supportPage" class="nav-btn-mobile w-full text-left font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Support</button>
                        <button data-page="profilePage" class="nav-btn-mobile w-full text-left font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition">Profile</button>
                    </div>
                </div>
            </header>

            <main class="flex-grow">
                <div id="pageContent" class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8">
                    <!-- Dynamic Page Content Goes Here -->
                </div>
            </main>
		<footer class="bg-gray-800 text-white mt-auto">
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center">
        <p>&copy; 2025 Study Buddy. All Rights Reserved. Made by Naresh for Students</p>
    </div>
</footer>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="adminDashboardPage" class="page hidden p-4 sm:p-6 md:p-8">
             <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Admin Dashboard</h2>
                    <div class="flex items-center space-x-4">
                        <button id="manageIssuesBtn" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition shadow-sm">Manage Issues</button>
                        <button id="manageUsersBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition shadow-sm">Manage Users</button>
                        <button id="adminLogoutBtn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition shadow-sm">Logout</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-xl p-6"><p class="text-sm font-medium text-gray-500">Total Users</p><p id="totalUsersStat" class="text-3xl font-bold text-gray-900">0</p></div>
                    <div class="bg-white rounded-2xl shadow-xl p-6"><p class="text-sm font-medium text-gray-500">Total Questions Asked</p><p id="totalQuestionsStat" class="text-3xl font-bold text-gray-900">0</p></div>
                    <div class="bg-white rounded-2xl shadow-xl p-6"><p class="text-sm font-medium text-gray-500">Questions in Bank</p><p id="questionBankStat" class="text-3xl font-bold text-gray-900">0</p></div>
                    <div class="bg-white rounded-2xl shadow-xl p-6"><p class="text-sm font-medium text-gray-500">Open Support Issues</p><p id="openIssuesStat" class="text-3xl font-bold text-red-500">0</p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-semibold mb-4">Manage Announcements</h3>
                        <div id="announcementListAdmin" class="space-y-2 mb-4 max-h-48 overflow-y-auto no-scrollbar border rounded-lg p-2 bg-gray-50"></div>
                        <div class="flex space-x-2">
                            <input id="newAnnouncementInput" type="text" placeholder="Type announcement here..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="addAnnouncementBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Post</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h3 class="text-xl font-semibold mb-4">Recently Added to Question Bank</h3>
                        <div id="adminHistoryContainer" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Page (Admin) -->
        <div id="userManagementPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">User Management</h2>
                    <button id="backToAdminDashboardBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to Dashboard</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-semibold mb-4">All Users</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white"><thead class="bg-gray-100"><tr><th class="text-left py-3 px-4 font-semibold text-sm">Name</th><th class="text-left py-3 px-4 font-semibold text-sm">Email</th><th class="text-left py-3 px-4 font-semibold text-sm">Questions Asked</th><th class="text-left py-3 px-4 font-semibold text-sm">Actions</th></tr></thead><tbody id="usersTableBody"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Management Page (Admin) -->
        <div id="issueManagementPage" class="page hidden p-4 sm:p-6 md:p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900">Issue Management</h2>
                    <button id="issueManagementBackBtn" class="bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-100 transition shadow-sm">Back to Dashboard</button>
                </div>
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h3 class="text-xl font-semibold mb-4">All Support Tickets</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">User</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Category</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Description</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Admin Notes</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Date</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Status</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">Action</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="collegeCourseModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md space-y-6">
                <h2 class="text-2xl font-bold text-gray-900 text-center">Select Your Course</h2>
                <div id="courseSelectionContainer" class="grid grid-cols-2 gap-4">
                    <button data-course="B.Tech CSE" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Tech CSE</button>
                    <button data-course="B.Tech ECE" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Tech ECE</button>
                    <button data-course="BCA" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">BCA</button>
                    <button data-course="BBA" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">BBA</button>
                    <button data-course="B.Sc" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">B.Sc</button>
                    <button data-course="Other" class="course-btn bg-gray-100 hover:bg-gray-200 font-semibold py-3 rounded-lg">Other</button>
                </div>
            </div>
        </div>

        <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 z-50 hidden">
            <video id="cameraView" autoplay playsinline class="mb-4 max-w-full rounded-lg"></video>
            <canvas id="cameraCanvas" class="hidden"></canvas>
            <div class="flex space-x-4">
                <button id="captureBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700">Capture</button>
                <button id="closeCameraBtn" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-700">Close</button>
            </div>
        </div>

        <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg space-y-6">
                <h2 class="text-2xl font-bold text-gray-900">Edit User Details</h2>
                <div>
                    <label for="editUserName" class="block text-sm font-medium text-gray-700">User Name</label>
                    <input type="text" id="editUserName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <input type="hidden" id="editUserId">
                </div>
                <div class="flex justify-end space-x-4">
                    <button id="closeEditModalBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="saveUserChangesBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mt-6 mb-2">Question History</h3>
                    <div id="modalUserHistoryContainer" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar border p-3 rounded-lg bg-gray-50"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page HTML Templates -->
    <template id="mainAppPageTemplate">
        <div id="announcementsContainer" class="mb-8 space-y-4"></div>
        <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
            <div class="flex border-b border-gray-200 mb-6">
                <button id="scanTab" class="py-3 px-4 font-semibold text-blue-600 border-b-2 border-blue-600 focus:outline-none w-1/2 text-center transition-colors">Scan</button>
                <button id="typeTab" class="py-3 px-4 font-semibold text-gray-500 focus:outline-none w-1/2 text-center transition-colors hover:text-blue-500">Type</button>
            </div>
            <div id="scanContent" class="tab-content">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Upload Your Question</h2>
                <div class="relative w-full">
                    <input type="file" id="questionScanner" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                    <div id="file-display" class="flex items-center justify-center w-full h-32 sm:h-40 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="text-center px-2">
                            <svg class="mx-auto h-10 w-10 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <p id="file-text" class="mt-2 text-sm text-gray-600 truncate">Click to upload an image</p>
                        </div>
                    </div>
                </div>
                <button id="openCameraBtn" class="w-full mt-4 bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg hover:bg-gray-800 transition-all duration-300 transform hover:scale-105 shadow-md">Scan with Camera</button>
            </div>
            <div id="typeContent" class="hidden tab-content">
                <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Enter Your Question</h2>
                <textarea id="manualQuestion" class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Type your question here..."></textarea>
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">Answer Length</h3>
                <div class="flex justify-center space-x-4 sm:space-x-8 bg-gray-50 p-3 rounded-lg">
                    <div class="flex items-center"><input id="shortAnswerOption" type="radio" name="answerLength" value="short" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked><label for="shortAnswerOption" class="ml-2 block text-sm font-medium text-gray-700">Short</label></div>
                    <div class="flex items-center"><input id="longAnswerOption" type="radio" name="answerLength" value="long" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><label for="longAnswerOption" class="ml-2 block text-sm font-medium text-gray-700">Long</label></div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 text-center">Answer Language</h3>
                <div class="flex justify-center space-x-4 sm:space-x-8 bg-gray-50 p-3 rounded-lg">
                    <div class="flex items-center"><input id="englishLangOption" type="radio" name="answerLanguage" value="English" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked><label for="englishLangOption" class="ml-2 block text-sm font-medium text-gray-700">English</label></div>
                    <div class="flex items-center"><input id="hindiLangOption" type="radio" name="answerLanguage" value="Hindi" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"><label for="hindiLangOption" class="ml-2 block text-sm font-medium text-gray-700">हिन्दी</label></div>
                </div>
            </div>
            <button id="getAnswerBtn" class="w-full mt-8 bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">Get Answer</button>
        </div>
        <div id="resultContainer" class="mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Solution</h2>
            <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto my-4 hidden"></div>
            <div id="answer" class="text-gray-700 leading-relaxed prose max-w-none"></div>
        </div>
        <div id="videoContainer" class="mt-8 bg-white rounded-2xl shadow-xl p-6 sm:p-8 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">Recommended Video</h2>
            <div id="videoPlayerWrapper" class="video-container"><iframe id="videoPlayer" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
        </div>
        <div id="errorBox" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="errorMessage"></span>
        </div>
    </template>

    <template id="profilePageTemplate">
        <div class="space-y-8">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Your Details</h3>
                <div class="space-y-4">
                    <input id="profileName" type="text" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <input id="profileEmail" type="email" placeholder="Your Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" disabled>
                    <button id="updateProfileBtn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105 shadow-md">Update Name</button>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Your Focus</h3>
                <div class="flex items-center justify-between">
                    <p class="text-gray-700">Current focus: <strong id="currentUserFocus">Loading...</strong></p>
                    <button id="changeFocusBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Change</button>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Your Past Questions</h3>
                <div id="historyContainer" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar"><p class="text-gray-500">You haven't asked any questions yet.</p></div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Account</h3>
                <button id="logoutBtn" class="w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition shadow-md">Logout</button>
            </div>
        </div>
    </template>
    
    <template id="quizListPageTemplate">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Quizzes</h2>
            <p class="text-gray-600 mb-6">Test your knowledge with a quick, auto-generated quiz based on your focus.</p>
            <button id="generateQuizBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition">Generate 5-Question Quiz</button>
        </div>
    </template>

    <template id="quizTakerPageTemplate">
         <div class="max-w-2xl w-full mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Quiz in Progress</h2>
                <div class="text-lg font-semibold bg-red-500 text-white px-4 py-1 rounded-full"><span id="quizTimer">10:00</span></div>
            </div>
            <div id="quizQuestionContainer" class="pt-4">
                <p class="text-gray-500 text-sm">Question <span id="currentQuestionNumber">1</span> of <span id="totalQuizQuestions">5</span></p>
                <p id="quizQuestionText" class="text-lg font-medium mt-2">Loading question...</p>
                <div id="quizOptionsContainer" class="space-y-3 mt-4"></div>
            </div>
            <button id="nextQuestionBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Next Question</button>
        </div>
    </template>

    <template id="quizResultPageTemplate">
        <div class="max-w-2xl w-full mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6 text-center">
            <h2 class="text-3xl font-bold text-gray-900">Quiz Complete!</h2>
            <p class="text-xl">Your Score: <span id="finalScore" class="font-bold text-green-600">0/5</span></p>
            <div id="quizReviewContainer" class="space-y-4 text-left max-h-96 overflow-y-auto no-scrollbar pt-4"></div>
            <button id="backToQuizzesBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700">Back to Quizzes</button>
        </div>
    </template>

    <template id="announcementHistoryPageTemplate">
        <div class="bg-white rounded-2xl shadow-xl p-8 space-y-4">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Announcement History</h2>
            <div id="allAnnouncementsContainer" class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar"><p class="text-gray-500">Loading announcements...</p></div>
        </div>
    </template>

    <template id="supportPageTemplate">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Submit a New Ticket</h3>
                <div class="space-y-4">
                    <div>
                        <label for="issueCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="issueCategory" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>Technical Issue</option>
                            <option>Billing Problem</option>
                            <option>Feedback</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="issueDescription" class="block text-sm font-medium text-gray-700">Describe your issue</label>
                        <textarea id="issueDescription" rows="4" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" placeholder="Please provide as much detail as possible..."></textarea>
                    </div>
                    <button id="submitTicketBtn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition">Submit Ticket</button>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h3 class="text-xl font-semibold mb-4">Your Ticket History</h3>
                <div id="ticketHistoryContainer" class="space-y-4 max-h-96 overflow-y-auto no-scrollbar">
                    <p class="text-gray-500">Your submitted support tickets will appear here.</p>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, getDocs, onSnapshot, updateDoc, arrayUnion, deleteDoc, serverTimestamp, orderBy, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyAFBbsNLT4TdPT_ufuo6dYG_nqCCoVYEa0",
            authDomain: "cbse-4fbf5.firebaseapp.com",
            projectId: "cbse-4fbf5",
            storageBucket: "cbse-4fbf5.appspot.com",
            messagingSenderId: "81006126716",
            appId: "1:81006126716:web:7ec193f5f32424c3460bf9",
            measurementId: "G-FK9D0L8T75"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & Variables ---
        let stream;
        let base64ImageData = null;
        let activeTab = 'scan';
        let quizTimerInterval;
        let confirmCallback = null;

        // --- DOM Element References ---
        const pageContainer = document.getElementById('pageContent');
        const allPages = document.querySelectorAll('.page');
        const mainAppWrapper = document.getElementById('mainAppWrapper');

        // --- UI Helper Functions ---
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'px-6 py-3 rounded-full text-white font-medium shadow-lg'; // Reset classes
            toast.classList.add('show', type === 'success' ? 'bg-green-500' : 'bg-red-500');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };

        const showConfirm = (title, message, onConfirm) => {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirmationModal').classList.remove('hidden');
        };

        document.getElementById('confirmOkBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            document.getElementById('confirmationModal').classList.add('hidden');
            confirmCallback = null;
        });

        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            document.getElementById('confirmationModal').classList.add('hidden');
            confirmCallback = null;
        });

        // --- Page Navigation ---
        const showPage = (pageId) => {
            allPages.forEach(page => page.classList.add('hidden'));
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) {
                pageToShow.classList.remove('hidden');
            }
        };

        const renderPage = (templateId) => {
            const template = document.getElementById(templateId);
            if (template) {
                pageContainer.innerHTML = '';
                pageContainer.appendChild(template.content.cloneNode(true));
                addPageSpecificEventListeners(templateId);
                return true;
            }
            return false;
        };

        const navigateToPage = (pageId) => {
            if (renderPage(pageId + 'Template')) {
                // This page is part of the main app layout
                showPage('mainAppWrapper');
            } else {
                // This is a standalone page (like login, admin, etc.)
                showPage(pageId);
            }
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.email === 'admin@admin.com') {
                    showPage('adminDashboardPage');
                    loadAdminDashboard();
                } else {
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists() && docSnap.data().grade) {
                        navigateToPage('mainAppPage');
                        loadAnnouncementsForUser();
                    } else {
                        document.getElementById('setupUserName').textContent = user.displayName || "there";
                        showPage('setupPage');
                    }
                }
            } else {
                showPage('loginPage');
            }
        });

        // Event Listeners for Auth Pages
        document.getElementById('showSignup').addEventListener('click', (e) => { e.preventDefault(); showPage('signupPage'); });
        document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); showPage('loginPage'); });

        document.getElementById('signupBtn').addEventListener('click', async () => {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (!name || !email || !password) { showToast("Please fill in all fields.", "error"); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: name });
                await setDoc(doc(db, "users", user.uid), { name: name, email: email, history: [] });
            } catch (error) { showToast(error.message, "error"); }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (email === 'admin' && password === 'admin@123') {
                try { await signInWithEmailAndPassword(auth, 'admin@admin.com', 'admin@123'); } 
                catch (error) { showToast("Admin account setup required.", "error"); }
                return;
            }
            try { await signInWithEmailAndPassword(auth, email, password); } 
            catch (error) { showToast(error.message, "error"); }
        });

        const performLogout = async () => {
            try { await signOut(auth); } 
            catch (error) { showToast(error.message, "error"); }
        };

        // --- Setup Flow ---
        async function saveUserSetup(grade, targetExam) {
            const user = auth.currentUser;
            if (!user) return;
            const userDocRef = doc(db, "users", user.uid);
            try {
                await setDoc(userDocRef, { grade, targetExam }, { merge: true });
                navigateToPage('mainAppPage');
            } catch (error) { showToast("Could not save preferences: " + error.message, "error"); }
        }

        document.getElementById('schoolCard').addEventListener('click', () => saveUserSetup('School (10-12)', 'School Exams'));
        document.getElementById('examCard').addEventListener('click', () => saveUserSetup('Competitive Exams', 'JEE/NEET'));
        document.getElementById('collegeCard').addEventListener('click', () => document.getElementById('collegeCourseModal').classList.remove('hidden'));
        document.getElementById('courseSelectionContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('course-btn')) {
                const course = e.target.dataset.course;
                saveUserSetup('College', course);
                document.getElementById('collegeCourseModal').classList.add('hidden');
            }
        });
        
        // --- Main App Navigation Listeners ---
        document.querySelectorAll('.nav-btn, .nav-btn-mobile').forEach(btn => {
            btn.addEventListener('click', () => {
                navigateToPage(btn.dataset.page);
                if (document.getElementById('mobileMenu').classList.contains('hidden') === false) {
                    document.getElementById('mobileMenu').classList.add('hidden');
                }
            });
        });

        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        });

        // --- Event Listener Delegation for Dynamic Content ---
        function addPageSpecificEventListeners(templateId) {
            switch (templateId) {
                case 'mainAppPageTemplate':
                    document.getElementById('getAnswerBtn').addEventListener('click', handleGetAnswer);
                    document.getElementById('scanTab').addEventListener('click', () => switchTab('scan'));
                    document.getElementById('typeTab').addEventListener('click', () => switchTab('type'));
                    document.getElementById('questionScanner').addEventListener('change', handleFileSelect);
                    document.getElementById('openCameraBtn').addEventListener('click', openCamera);
                    break;
                case 'profilePageTemplate':
                    loadUserProfile();
                    document.getElementById('updateProfileBtn').addEventListener('click', updateUserProfile);
                    document.getElementById('changeFocusBtn').addEventListener('click', () => showPage('setupPage'));
                    document.getElementById('logoutBtn').addEventListener('click', performLogout);
                    break;
                case 'quizListPageTemplate':
                    document.getElementById('generateQuizBtn').addEventListener('click', generateQuiz);
                    break;
                case 'quizTakerPageTemplate':
                    // Listeners are added when quiz starts
                    break;
                case 'quizResultPageTemplate':
                     document.getElementById('backToQuizzesBtn').addEventListener('click', () => navigateToPage('quizListPage'));
                    break;
                case 'announcementHistoryPageTemplate':
                    loadAllAnnouncements();
                    break;
                case 'supportPageTemplate':
                    loadUserTickets();
                    document.getElementById('submitTicketBtn').addEventListener('click', submitSupportTicket);
                    break;
            }
        }

        // --- Main App Page Functions ---
        function switchTab(tabName) {
            activeTab = tabName;
            const scanTab = document.getElementById('scanTab');
            const typeTab = document.getElementById('typeTab');
            const scanContent = document.getElementById('scanContent');
            const typeContent = document.getElementById('typeContent');

            if (tabName === 'scan') {
                scanTab.classList.add('text-blue-600', 'border-blue-600');
                scanTab.classList.remove('text-gray-500');
                typeTab.classList.remove('text-blue-600', 'border-blue-600');
                typeTab.classList.add('text-gray-500');
                scanContent.classList.remove('hidden');
                typeContent.classList.add('hidden');
            } else {
                typeTab.classList.add('text-blue-600', 'border-blue-600');
                typeTab.classList.remove('text-gray-500');
                scanTab.classList.remove('text-blue-600', 'border-blue-600');
                scanTab.classList.add('text-gray-500');
                typeContent.classList.remove('hidden');
                scanContent.classList.add('hidden');
            }
        }
        
        async function handleGetAnswer() {
             const user = auth.currentUser;
            if (!user) return;

            const answerDiv = document.getElementById('answer');
            const resultContainer = document.getElementById('resultContainer');
            const videoContainer = document.getElementById('videoContainer');
            const loader = document.getElementById('loader');
            const getAnswerBtn = document.getElementById('getAnswerBtn');
            
            answerDiv.innerHTML = '';
            resultContainer.classList.remove('hidden');
            videoContainer.classList.add('hidden');
            loader.classList.remove('hidden');
            getAnswerBtn.disabled = true;
            getAnswerBtn.textContent = 'Fetching Solution...';
            document.getElementById('errorBox').classList.add('hidden');

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (!userDoc.exists() || !userDoc.data().targetExam) {
                showError("Please set your focus in your profile before asking a question.");
                resetButtonState();
                return;
            }
            const userFocus = `${userDoc.data().grade} - ${userDoc.data().targetExam}`;

            try {
                const answerLength = document.querySelector('input[name="answerLength"]:checked').value;
                const answerLanguage = document.querySelector('input[name="answerLanguage"]:checked').value;
                const languageInstruction = answerLanguage === 'Hindi'
                    ? `Provide the entire response in Hindi (using Devanagari script).`
                    : `Provide the entire response in English.`;

                const promptInstruction = `You are an expert academic tutor for an Indian student whose focus is ${userFocus}. Your task is to answer the following question. ${languageInstruction} First, determine if the question is a valid, on-topic academic question relevant to this focus.
                - If it is relevant, provide a ${answerLength}, simple, step-by-step solution.
                - If the question is NOT a valid academic question (e.g., it's a joke, nonsense, or asks 'why Kattappa killed Baahubali'), you MUST respond with ONLY this exact text: 'This does not seem to be a valid academic question. Please ask a question related to your studies.'
                After providing a valid solution, on a new line, write "VIDEO_URL:" followed by a single, relevant YouTube video URL.
                Finally, on a new line, if the question can be converted into a multiple-choice question (MCQ), write "QUIZ_DATA:" followed by a valid JSON object. The JSON must have these keys: "question" (a concise string), "options" (an array of 4 strings), and "correctAnswer" (a string that exactly matches one of the options). If it cannot be made into an MCQ, omit the QUIZ_DATA line entirely.`;
                
                let userQuestion, prompt;
                if (activeTab === 'scan') {
                    if (!base64ImageData) { showError("Please upload or capture an image."); resetButtonState(); return; }
                    userQuestion = "Question from image";
                    prompt = `Analyze the image. Then, follow these instructions: ${promptInstruction}`;
                    await getSolution(prompt, base64ImageData, userQuestion, userFocus);
                } else {
                    const questionText = document.getElementById('manualQuestion').value.trim();
                    if (!questionText) { showError("Please type your question."); resetButtonState(); return; }
                    userQuestion = questionText;
                    prompt = `The user's question is: "${questionText}". Now, follow these instructions: ${promptInstruction}`;
                    await getSolution(prompt, null, userQuestion, userFocus);
                }
            } catch (error) {
                showError('Failed to fetch the solution.');
            } finally {
                resetButtonState();
            }
        }

        async function getSolution(prompt, imageData = null, userQuestion, topic) {
            const apiKey = "AIzaSyAVUM1iSxjffw7RgbEli0pOzMXTVqbxdRA"; // Replace with your key if needed
            const finalApiKey = typeof GEMINI_API_KEY !== 'undefined' ? GEMINI_API_KEY : apiKey;
            if (!finalApiKey) { showError("API Key is missing."); return; }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${finalApiKey}`;
            
            const parts = [{ text: prompt }];
            if (imageData) { parts.push({ inlineData: { mimeType: "image/jpeg", data: imageData } }); }
            const payload = { contents: [{ parts }] };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error.message); }
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0]) {
                    const fullResponseText = result.candidates[0].content.parts[0].text;
                    let solutionText = fullResponseText, videoUrl = null, quizData = null;
                    
                    const quizDataMatch = fullResponseText.match(/QUIZ_DATA:\s*({.*})/s);
                    if(quizDataMatch && quizDataMatch[1]){
                        try { quizData = JSON.parse(quizDataMatch[1]); } 
                        catch(e){ console.error("Failed to parse quiz JSON", e); quizData = null; }
                    }

                    const videoUrlMatch = fullResponseText.match(/VIDEO_URL:\s*(https?:\/\/[^\s]+)/);
                    if(videoUrlMatch && videoUrlMatch[1]){ videoUrl = videoUrlMatch[1]; }

                    solutionText = fullResponseText.split("VIDEO_URL:")[0].split("QUIZ_DATA:")[0].trim();
                    document.getElementById('answer').innerHTML = solutionText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/```(.*?)```/gs, '<pre class="bg-gray-100 p-3 rounded-md"><code>$1</code></pre>').replace(/\n/g, '<br>');
                    
                    if (videoUrl) { displayVideo(videoUrl); }
                    
                    await logQuestion(userQuestion, solutionText, topic, quizData);
                } else {
                    document.getElementById('answer').textContent = 'Could not generate a solution.';
                }
            } catch (error) {
                showError(error.message || "Issue connecting to the AI service.");
            }
        }

        // --- Profile Page Functions ---
        async function loadUserProfile() {
            const user = auth.currentUser;
            if (!user) return;
            document.getElementById('profileName').value = user.displayName || '';
            document.getElementById('profileEmail').value = user.email || '';
            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const userData = docSnap.data();
                const currentUserFocus = document.getElementById('currentUserFocus');
                currentUserFocus.textContent = (userData.grade && userData.targetExam) ? `${userData.grade} - ${userData.targetExam}` : 'Not set';
                
                const historyContainer = document.getElementById('historyContainer');
                historyContainer.innerHTML = '';
                if (userData.history && userData.history.length > 0) {
                    [...userData.history].reverse().forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'p-4 border rounded-lg bg-gray-50';
                        historyItem.innerHTML = `<p class="font-semibold text-gray-800">${item.question}</p><p class="text-sm text-gray-600 mt-2">${item.answer.substring(0, 150)}...</p><p class="text-xs text-gray-400 mt-2">${new Date(item.timestamp).toLocaleString()}</p>`;
                        historyContainer.appendChild(historyItem);
                    });
                } else {
                    historyContainer.innerHTML = '<p class="text-gray-500">You haven\'t asked any questions yet.</p>';
                }
            }
        }

        async function updateUserProfile() {
            const user = auth.currentUser;
            const newName = document.getElementById('profileName').value;
            if (!user || !newName) return;
            try {
                await updateProfile(user, { displayName: newName });
                await updateDoc(doc(db, "users", user.uid), { name: newName });
                showToast("Profile updated successfully!");
            } catch (error) {
                showToast("Failed to update profile: " + error.message, "error");
            }
        }

        // --- Support Page Functions ---
        async function submitSupportTicket() {
            const user = auth.currentUser;
            if (!user) { showToast("You must be logged in to submit a ticket.", "error"); return; }

            const category = document.getElementById('issueCategory').value;
            const description = document.getElementById('issueDescription').value.trim();
            if (!description) { showToast("Please describe your issue.", "error"); return; }

            try {
                await addDoc(collection(db, "issues"), {
                    userId: user.uid,
                    userName: user.displayName,
                    userEmail: user.email,
                    category: category,
                    description: description,
                    status: "Open",
                    adminNotes: "",
                    timestamp: serverTimestamp()
                });
                showToast("Support ticket submitted successfully!");
                document.getElementById('issueDescription').value = '';
                loadUserTickets();
            } catch (error) {
                showToast("Failed to submit ticket. Please try again.", "error");
            }
        }

        async function loadUserTickets() {
            const user = auth.currentUser;
            if (!user) return;

            const container = document.getElementById('ticketHistoryContainer');
            container.innerHTML = '<p class="text-gray-500">Loading your tickets...</p>';

            try {
                const q = query(collection(db, "issues"), where("userId", "==", user.uid));
                const querySnapshot = await getDocs(q);

                container.innerHTML = '';
                if (querySnapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500">You haven\'t submitted any tickets yet.</p>';
                    return;
                }
                
                const tickets = [];
                querySnapshot.forEach(doc => {
                    tickets.push(doc.data());
                });

                // Sort tickets by timestamp client-side
                tickets.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                tickets.forEach(ticket => {
                    const date = ticket.timestamp ? new Date(ticket.timestamp.toDate()).toLocaleString() : 'N/A';
                    
                    let statusColorClass = 'bg-red-100 text-red-800';
                    if (ticket.status === 'In Progress') statusColorClass = 'bg-yellow-100 text-yellow-800';
                    if (ticket.status === 'Resolved') statusColorClass = 'bg-green-100 text-green-800';

                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'p-4 border rounded-lg bg-gray-50';
                    
                    let adminNotesHTML = '';
                    if (ticket.adminNotes) {
                        adminNotesHTML = `
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-sm font-semibold text-gray-700">Admin Response:</p>
                                <p class="text-sm text-gray-600 mt-1">${ticket.adminNotes}</p>
                            </div>
                        `;
                    }

                    ticketDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="font-semibold text-gray-800">${ticket.category}</p>
                            <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColorClass}">${ticket.status}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${ticket.description}</p>
                        ${adminNotesHTML}
                        <p class="text-xs text-gray-400 mt-3 text-right">${date}</p>
                    `;
                    container.appendChild(ticketDiv);
                });
            } catch (error) {
                console.error("Error loading user tickets: ", error);
                container.innerHTML = '<p class="text-red-500 font-medium">Could not load tickets. Please try again later.</p>';
            }
        }

        // --- Quiz Functions ---
        async function generateQuiz() {
            const user = auth.currentUser;
            if(!user) return;

            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            if(!docSnap.exists() || !docSnap.data().targetExam) {
                showToast("Please set your focus in your profile first.", "error");
                return;
            }
            const userFocus = `${docSnap.data().grade} - ${docSnap.data().targetExam}`;
            
            const q = query(collection(db, "questionBank"), where("topic", "==", userFocus), where("options", "!=", null), limit(5));
            const snapshot = await getDocs(q);
            
            if(snapshot.docs.length < 5) {
                showToast("Not enough quiz questions in the bank for your focus area yet. Ask more questions to build it up!", "error");
                return;
            }

            const quizQuestions = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
            startQuiz(quizQuestions);
        }

        function startQuiz(questions) {
            navigateToPage('quizTakerPage');
            
            let currentQuestionIndex = 0;
            let userAnswers = [];
            let currentSelection = null;

            function displayQuestion() {
                currentSelection = null;
                const question = questions[currentQuestionIndex];
                document.getElementById('currentQuestionNumber').textContent = currentQuestionIndex + 1;
                document.getElementById('totalQuizQuestions').textContent = questions.length;
                document.getElementById('quizQuestionText').innerHTML = question.question.replace(/\n/g, '<br>');
                
                const optionsContainer = document.getElementById('quizOptionsContainer');
                optionsContainer.innerHTML = '';
                
                const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);

                shuffledOptions.forEach(option => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'quiz-option w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition';
                    optionBtn.textContent = option;
                    optionBtn.dataset.option = option;
                    optionsContainer.appendChild(optionBtn);
                });

                document.getElementById('nextQuestionBtn').textContent = currentQuestionIndex === questions.length - 1 ? "Finish Quiz" : "Next Question";
            }
            
            document.getElementById('quizOptionsContainer').onclick = (e) => {
                if (e.target && e.target.classList.contains('quiz-option')) {
                    const allOptions = document.querySelectorAll('.quiz-option');
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    e.target.classList.add('selected');
                    currentSelection = e.target.dataset.option;
                }
            };

            function finishQuiz() {
                clearInterval(quizTimerInterval);
                navigateToPage('quizResultPage');

                let score = 0;
                userAnswers.forEach((ans, index) => {
                    if (ans === questions[index].correctAnswer) {
                        score++;
                    }
                });

                document.getElementById('finalScore').textContent = `${score}/${questions.length}`;
                const reviewContainer = document.getElementById('quizReviewContainer');
                reviewContainer.innerHTML = '';

                questions.forEach((q, index) => {
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === q.correctAnswer;
                    
                    let optionsHtml = '';
                    q.options.forEach(opt => {
                        let style = 'border-gray-300';
                        if (opt === q.correctAnswer) {
                            style = 'bg-green-100 border-green-500 text-green-800';
                        } else if (opt === userAnswer && !isCorrect) {
                            style = 'bg-red-100 border-red-500 text-red-800';
                        }
                        optionsHtml += `<li class="p-2 border rounded-md ${style}">${opt}</li>`;
                    });

                    reviewContainer.innerHTML += `
                        <div class="p-4 border rounded-lg ${isCorrect ? 'bg-green-50' : 'bg-red-50'}">
                            <p class="font-semibold">${index + 1}. ${q.question}</p>
                            <ul class="list-none space-y-2 mt-3">${optionsHtml}</ul>
                        </div>
                    `;
                });
            }

            document.getElementById('nextQuestionBtn').onclick = () => {
                userAnswers.push(currentSelection);
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    displayQuestion();
                } else {
                    finishQuiz();
                }
            };

            let timeLeft = 600; 
            const timerEl = document.getElementById('quizTimer');
            timerEl.textContent = '10:00';
            quizTimerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    finishQuiz();
                }
            }, 1000);

            displayQuestion();
        }

        // --- Other Helper Functions ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('file-text').textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => { base64ImageData = e.target.result.split(',')[1]; };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('file-text').textContent = 'Click to upload an image';
                base64ImageData = null;
            }
        }

        async function openCamera() {
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('cameraView').srcObject = stream;
            } catch (err) {
                showError("Could not access the camera.");
                closeCamera();
            }
        }
        
        function closeCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); }
            const cameraModal = document.getElementById('cameraModal');
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
        }
        
        document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);
        
        document.getElementById('captureBtn').addEventListener('click', () => {
            const cameraView = document.getElementById('cameraView');
            const cameraCanvas = document.getElementById('cameraCanvas');
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraView.videoWidth;
            cameraCanvas.height = cameraView.videoHeight;
            context.drawImage(cameraView, 0, 0, cameraCanvas.width, cameraCanvas.height);
            base64ImageData = cameraCanvas.toDataURL('image/jpeg').split(',')[1];
            
            if(document.getElementById('file-text')) {
               document.getElementById('file-text').textContent = 'Image captured from camera.';
            }
            closeCamera();
        });

        function resetButtonState() { 
            const getAnswerBtn = document.getElementById('getAnswerBtn');
            if(getAnswerBtn) {
                document.getElementById('loader').classList.add('hidden');
                getAnswerBtn.disabled = false;
                getAnswerBtn.textContent = 'Get Answer';
            }
        }
        function showError(message) { 
            const errorBox = document.getElementById('errorBox');
            if(errorBox) {
                document.getElementById('errorMessage').textContent = message;
                errorBox.classList.remove('hidden');
                document.getElementById('resultContainer').classList.add('hidden');
                document.getElementById('videoContainer').classList.add('hidden');
            }
        }
        async function logQuestion(question, answer, topic, quizData = null) {
            const user = auth.currentUser;
            if (!user) return;
            const logEntry = { question: quizData ? quizData.question : question, answer, timestamp: Date.now(), userId: user.uid, userEmail: user.email, userName: user.displayName || 'Unknown', topic };
            await updateDoc(doc(db, "users", user.uid), { history: arrayUnion({ question, answer, timestamp: logEntry.timestamp }) });
            await addDoc(collection(db, "questions"), logEntry);
            if (!answer.includes("not seem to be a valid academic question") && quizData && quizData.options && quizData.correctAnswer) {
                const bankEntry = { ...logEntry, question: quizData.question, options: quizData.options, correctAnswer: quizData.correctAnswer, timestamp: serverTimestamp() };
                delete bankEntry.answer;
                await addDoc(collection(db, "questionBank"), bankEntry);
            }
        }
        function displayVideo(url) {
            let videoId = null;
            try {
                const urlObj = new URL(url);
                videoId = (urlObj.hostname === 'youtu.be') ? urlObj.pathname.substring(1) : urlObj.searchParams.get('v');
            } catch (e) { return; }
            if (videoId) {
                document.getElementById('videoPlayer').src = `https://www.youtube.com/embed/${videoId}`;
                document.getElementById('videoContainer').classList.remove('hidden');
            }
        }
        async function loadAllAnnouncements() {
            const container = document.getElementById('allAnnouncementsContainer');
            container.innerHTML = '<p class="text-gray-500">Loading announcements...</p>';
            const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            container.innerHTML = '';
            if (querySnapshot.empty) {
                container.innerHTML = '<p class="text-gray-500">There are no announcements yet.</p>';
            } else {
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'Just now';
                    const announcementDiv = document.createElement('div');
                    announcementDiv.className = 'bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg shadow-sm';
                    announcementDiv.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold">📢 Announcement</p><p class="text-xs text-blue-600">${date}</p></div><p class="mt-1">${data.message}</p>`;
                    container.appendChild(announcementDiv);
                });
            }
        }
        async function loadAnnouncementsForUser() {
            const container = document.getElementById('announcementsContainer');
            if (!container) return; 
            const q = query(collection(db, "announcements"), orderBy("timestamp", "desc"), limit(3));
            const querySnapshot = await getDocs(q);
            container.innerHTML = '';
            if (querySnapshot.empty) {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
                querySnapshot.forEach(doc => {
                    const announcementDiv = document.createElement('div');
                    announcementDiv.className = 'bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg shadow';
                    announcementDiv.innerHTML = `<p class="font-bold">📢 Announcement</p><p>${doc.data().message}</p>`;
                    container.appendChild(announcementDiv);
                });
            }
        }

        // --- Admin Functions ---
        document.getElementById('adminLogoutBtn').addEventListener('click', performLogout);
        document.getElementById('manageUsersBtn').addEventListener('click', () => { showPage('userManagementPage'); loadUsersForManagement(); });
        document.getElementById('backToAdminDashboardBtn').addEventListener('click', () => showPage('adminDashboardPage'));
        document.getElementById('manageIssuesBtn').addEventListener('click', () => { showPage('issueManagementPage'); loadAllIssues(); });
        document.getElementById('issueManagementBackBtn').addEventListener('click', () => showPage('adminDashboardPage'));

        function loadAdminDashboard() {
            onSnapshot(collection(db, "users"), (snap) => { document.getElementById('totalUsersStat').textContent = snap.size; });
            onSnapshot(collection(db, "questions"), (snap) => { document.getElementById('totalQuestionsStat').textContent = snap.size; });
            onSnapshot(collection(db, "questionBank"), (snap) => { document.getElementById('questionBankStat').textContent = snap.size; });
            onSnapshot(query(collection(db, "issues"), where("status", "==", "Open")), (snap) => { document.getElementById('openIssuesStat').textContent = snap.size; });
        }

        async function loadUsersForManagement() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Loading...</td></tr>';
            const snapshot = await getDocs(collection(db, "users"));
            if (snapshot.empty) { usersTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">No users found.</td></tr>'; return; }
            usersTableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const userData = doc.data();
                const questionsCount = userData.history ? userData.history.length : 0;
                const row = usersTableBody.insertRow();
                row.className = 'border-b';
                row.innerHTML = `<td class="py-3 px-4">${userData.name || 'N/A'}</td><td class="py-3 px-4">${userData.email}</td><td class="py-3 px-4">${questionsCount}</td><td class="py-3 px-4"><button class="edit-btn bg-blue-100 text-blue-700 text-xs font-semibold mr-2 px-2.5 py-1 rounded-full" data-id="${doc.id}">Edit</button><button class="delete-btn bg-red-100 text-red-700 text-xs font-semibold px-2.5 py-1 rounded-full" data-id="${doc.id}">Delete</button></td>`;
            });
        }

        document.getElementById('usersTableBody').addEventListener('click', async (e) => {
            const userId = e.target.dataset.id;
            if (!userId) return;
            if (e.target.classList.contains('edit-btn')) { /* openEditModal(userId); */ } 
            else if (e.target.classList.contains('delete-btn')) { 
                showConfirm('Delete User?', `Are you sure you want to delete this user? This action is permanent.`, () => deleteUser(userId));
            }
        });

        async function deleteUser(userId) {
            try {
                await deleteDoc(doc(db, "users", userId));
                showToast("User data deleted successfully.");
                loadUsersForManagement();
            } catch (error) { showToast("Failed to delete user data.", "error"); }
        }

        async function loadAllIssues() {
            const issuesTableBody = document.getElementById('issuesTableBody');
            issuesTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Loading issues...</td></tr>';
            const q = query(collection(db, "issues"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { issuesTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">No support tickets found.</td></tr>'; return; }
                issuesTableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const issue = doc.data();
                    const issueId = doc.id;
                    const date = issue.timestamp ? new Date(issue.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    const row = issuesTableBody.insertRow();
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm"><p class="font-semibold">${issue.userName}</p><p class="text-gray-500">${issue.userEmail}</p></td>
                        <td class="py-3 px-4 text-sm">${issue.category}</td>
                        <td class="py-3 px-4 text-sm max-w-xs truncate" title="${issue.description}">${issue.description}</td>
                        <td class="py-3 px-4 text-sm"><textarea data-id="${issueId}" class="admin-notes-input w-full p-1 border border-gray-300 rounded-md">${issue.adminNotes || ''}</textarea></td>
                        <td class="py-3 px-4 text-sm">${date}</td>
                        <td class="py-3 px-4 text-sm">
                            <select data-id="${issueId}" class="status-select w-full p-1 border-gray-300 rounded-md">
                                <option value="Open" ${issue.status === 'Open' ? 'selected' : ''}>Open</option>
                                <option value="In Progress" ${issue.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                <option value="Resolved" ${issue.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                            </select>
                        </td>
                        <td class="py-3 px-4 text-sm">
                            <button data-id="${issueId}" class="save-status-btn bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-md hover:bg-blue-600">Update</button>
                        </td>
                    `;
                });
            });
        }
        
        document.getElementById('issuesTableBody').addEventListener('click', async (e) => {
            if (e.target.classList.contains('save-status-btn')) {
                const issueId = e.target.dataset.id;
                const newStatus = document.querySelector(`.status-select[data-id="${issueId}"]`).value;
                const adminNotes = document.querySelector(`.admin-notes-input[data-id="${issueId}"]`).value;
                try {
                    await updateDoc(doc(db, "issues", issueId), { 
                        status: newStatus,
                        adminNotes: adminNotes
                    });
                    showToast("Issue updated successfully!");
                } catch (error) {
                    showToast("Failed to update issue.", "error");
                }
            }
        });

    </script>

</body>
</html>
